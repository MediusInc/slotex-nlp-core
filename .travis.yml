sudo: required
language: java
dist: trusty
jdk: oraclejdk8
install: mvn dependency:resolve
cache:
  directories:
    - $HOME/bin
    - $HOME/.m2

notifications:
  slack: pkp2019-slotex:$SLACK_TOKEN
  email: false


branches:
  except:
     - /^v[0-9]/

addons:
  sonarcloud:
    organization: "mediusinc"

env:
  global:
    - DOCKER_COMPOSE_VERSION=1.24.1
    - IMAGE_NAME=pkpslotex/slotex-nlp-core

services:
  - docker
  - redis-server
  - mongodb

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - if [ ! -f "$HOME/bin/docker-compose" ]; then curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > $HOME/bin/docker-compose; fi
  - chmod +x $HOME/bin/docker-compose
  - sudo cp $HOME/bin/docker-compose /usr/local/bin/
  
before_script:
  # before installing dependencies
  - source dependencies
  - docker-compose up -d mongodb redis

script:
  - mvn clean verify -P sonar -Dsonar.login=$SONAR_TOKEN
  - mvn package
  - docker-compose down

after_success:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - export IMAGE_NAME=pkpslotex/slotex-nlp-core
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_COMMIT; fi`
  - docker build -t $IMAGE_NAME:$TRAVIS_COMMIT .
  - docker tag $IMAGE_NAME:$TRAVIS_COMMIT $IMAGE_NAME:$TAG
  - docker push $IMAGE_NAME:$TAG
  - bash ./.travis/update-readme.sh

deploy:
  provider: script
  script: evn IMAGE_NAME=pkpslotex/slotex-nlp-core ./.travis/release-docker-image.sh
  on:
    tags: true
